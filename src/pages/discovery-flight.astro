---
import ImageComp from "../components/ImageComp.astro";
import DiscoveryFlightLayout from "../layouts/DiscoveryFlightLayout.astro";
const DISCOVERY_FLIGHT_FORM_WEBHOOK_URL = import.meta.env
  .DISCOVERY_FLIGHT_FORM_WEBHOOK_URL;
const PORTAL_API_KEY = import.meta.env.PORTAL_API_KEY;
---

<DiscoveryFlightLayout
  siteTitle="Discovery Flight in Ogden, Utah | Experience Flying with Blitz Aviation"
  siteDescription="Experience the thrill of piloting an aircraft with a Discovery Flight at Blitz Aviation in Ogden, Utah. Fly over breathtaking mountain views with an experienced instructor. Perfect for beginners considering flight training."
  siteKeywords="discovery flight Utah, introductory flight lesson, first-time flying experience, trial flight Ogden, airplane experience Salt Lake City, learn to fly Utah, discovery flight cost, beginner pilot experience, scenic flight Ogden mountains, flying lesson trial, first flight experience"
>
  <section class="flex">
    <div
      class="flex flex-col gap-3 max-w-screen-sm px-5 py-10 lg:py-28 lg:px-28 lg:min-w-[640px] mx-auto lg:mx-0"
    >
      <a href="/">
        <ImageComp
          alt="Blitz Aviation Logo"
          src="/src/assets/logos/blitz-logo.webp"
          classes="w-28 mb-5"
        />
      </a>
      <h1
        class="text-sm/5 font-semibold text-gray-500 uppercase tracking-widest"
      >
        Request a Discovery Flight
      </h1>
      <h2
        class="max-w-lg text-pretty text-2xl font-semibold tracking-tight text-main-black sm:text-3xl"
      >
        Depart from Ogden-Hinckley Airport with Blitz Aviation
      </h2>
      <p class="text-lg my-2">
        Take the controls and experience the thrill of flying with our discovery
        flight program. You'll fly with an experienced flight instructor who
        will guide you through the basics and let you experience the joy of
        flight firsthand.
      </p>
      <p class="italic text-sm text-blue-800 tracking-wide">
        IMPORTANT: Please ensure that you have talked with an Blitz Aviation
        team member to confirm your flight. This page is just to REQUEST a
        discovery flight. You will not be in the flight schedule until you speak
        with an Blitz Aviation team member.
      </p>
      <form
        id="discovery-flight-form"
        class="flex flex-col max-w-4xl mx-auto lg:my-0 bg-white shadow-sm"
      >
        <div class="flex flex-col gap-2">
          <label for="first-name" class="font-medium mt-2 text-gray-500"
            >First Name</label
          >
          <input
            type="text"
            name="first-name"
            class="px-2 py-2 outline-1 w-full border-gray-400 border outline-gray-500"
            required
          />
          <label for="last-name" class="font-medium mt-2 text-gray-500"
            >Last Name</label
          >
          <input
            type="text"
            name="last-name"
            class="px-2 py-2 outline-1 w-full border-gray-400 border outline-gray-500"
            required
          />
          <label for="email" class="font-medium mt-2 text-gray-500">Email</label
          >
          <input
            id="email"
            type="email"
            name="email"
            class="px-2 py-2 outline-1 w-full border-gray-400 border outline-gray-500"
            required
          />
          <input
            type="email"
            name="confirm-email"
            placeholder="Confirm email"
            class="hidden"
          />
          <label for="phone" class="font-medium mt-2 text-gray-500">Phone</label
          >
          <input
            type="tel"
            name="phone"
            class="px-2 py-2 outline-1 w-full border-gray-400 border outline-gray-500"
            required
          />
          <label for="preferred-date" class="font-medium mt-2 text-gray-500"
            >Preferred Discovery Flight Date</label
          >
          <input
            id="date"
            type="date"
            name="preferred-date"
            class="px-2 py-2 outline-1 w-full border-gray-400 border outline-gray-500"
            required
          />
          <label for="preferred-time" class="font-medium mt-2 text-gray-500"
            >Preferred Discovery Flight Time</label
          >
          <select
            name="preferred-time"
            class="px-2 py-2 outline-1 w-full border-gray-400 border outline-gray-500 bg-white"
            required
          >
            <option value="7AM - 10AM">7AM - 10AM</option>
            <option value="10AM - 1PM">10AM - 1PM</option>
            <option value="1PM - 4PM">1PM - 4PM</option>
            <option value="4PM - 7PM">4PM - 7PM</option>
          </select>
          <label for="additional-info" class="font-medium mt-2 text-gray-500">
            Any additional information
          </label>
          <textarea
            id="additional-info"
            name="additional-info"
            class="px-2 py-2 outline-1 border-gray-400 border outline-gray-500 min-h-32"
          ></textarea>
        </div>

        <div class="flex gap-3">
          <input
            type="checkbox"
            name="agree-data-collection"
            id="agree-data-collection"
            required
          />

          <label for="agree-data-collection" class="text-gray-500 text-sm my-5">
            I agree to the terms & conditions provided by the company. By
            providing my email and phone number, I agree to receive email and
            text messages from Blitz Aviation.
          </label>
        </div>
        <button id="submit-button" type="submit" class="btn-primary"
          >Request</button
        >
      </form>
    </div>
    <div
      class="w-full hidden lg:block fixed right-0 bottom-0 top-0 left-[640px]"
    >
      <ImageComp
        alt="View from discovery flight in Ogden, Utah"
        src="/src/assets/images/discovery-flight-view-at-blitz-aviation.webp"
        classes="w-full h-full object-cover"
        quality={100}
      />
    </div>
  </section>

  <script define:vars={{ DISCOVERY_FLIGHT_FORM_WEBHOOK_URL, PORTAL_API_KEY }}>
    const dateInput = document.getElementById("date");

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const minDate = new Date(today);
    minDate.setDate(today.getDate() + 5);

    const formatDate = (date) => {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const day = String(date.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    };

    dateInput.min = formatDate(minDate);

    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("discovery-flight-form");
      if (!form) {
        console.error("Form element not found.");
        return;
      }

      form.addEventListener("submit", async (event) => {
        event.preventDefault();

        const formData = new FormData(form);
        const confirmEmail = formData.get("confirm-email")?.trim();

        if (confirmEmail) return;

        const webhookURL = DISCOVERY_FLIGHT_FORM_WEBHOOK_URL;
        const apiKey = PORTAL_API_KEY;

        const urlEncodedBody = new URLSearchParams(formData).toString();

        const jsonBody = {
          first_name: formData.get("first-name")?.trim() || "",
          last_name: formData.get("last-name")?.trim() || "",
          email: formData.get("email")?.trim() || "",
          phone: formData.get("phone")?.trim() || "",
          campaign: "discovery_flight_form",
          account_random_id: "ac_ly7kki3x",
          metadata: {
            preferred_date: formData.get("preferred-date")?.trim() || "",
            preferred_time: formData.get("preferred-time")?.trim() || "",
            additional_info: formData.get("additional-info")?.trim() || "",
          },
        };

        try {
          const [ghlRes, portalRes] = await Promise.all([
            fetch(webhookURL, {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: urlEncodedBody,
            }),
            fetch("https://portal.rightruddermarketing.com/api/leads", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
                "x-api-key": apiKey,
              },
              body: JSON.stringify(jsonBody),
            }),
          ]);

          if (ghlRes.ok && portalRes.ok) {
            window.location.href = "/contact-confirmation";
          } else {
            console.error("Submission failed", {
              ghlStatus: ghlRes.status,
              portalStatus: portalRes.status,
            });
          }
        } catch (err) {
          console.error("Submission error:", err);
        }
      });
    });
  </script>
</DiscoveryFlightLayout>
